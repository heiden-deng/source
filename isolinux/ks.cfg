# Kickstart file automatically generated by anaconda.

#version=DEVEL
install
cdrom
lang zh_CN.UTF-8
keyboard us
network --onboot yes --device eth0 --bootproto dhcp --noipv6
rootpw  --iscrypted $6$7TbdYT3hBz/d3t5w$yxD51TKnvvTQKVimUXwohT2.iAmnNYbqXehwdtRoXI/Q1gDv6sGZVrzjHMe.IB/Eg6vIvWhUwhHeO03zeIZl90
firewall --service=ssh --port=8821:tcp,7767:tcp,8901:tcp,7771:tcp,7777:tcp,44444:tcp,16509:tcp,16514:tcp,11111:tcp
authconfig --enableshadow --passalgo=sha512
selinux --disabled
timezone Asia/Shanghai
#bootloader --location=mbr --driveorder=sda --append="crashkernel=auto rhgb quiet"
# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work
#clearpart --all --drives=sda

%include /tmp/disk.cfg

part /boot --fstype=ext4 --size=1024

part pv.008002 --grow --size=1
volgroup vg_vcell18 --pesize=4096 pv.008002
logvol / --fstype=ext4 --name=lv_root --vgname=vg_vcell18 --grow --size=1024 --maxsize=512000
logvol swap --name=lv_swap --vgname=vg_vcell18 --recommended

reboot --eject
#repo --name="Sugon mini"  --baseurl=cdrom:sr0 --cost=100

%packages --nobase
@core
%end

%pre
chvt 2
tag_disk="sda"
tag_driveorder=""
tag_drives=""
min_size_tag=40000000000
min_size="$min_size_tag"

ret=`cat /proc/cmdline | grep "is_efi=1"`
if [ -z "$ret" ];then

cat >> /tmp/disk.cfg <<EOF
bootloader --location=mbr $tag_driveorder --append="crashkernel=auto rhgb quiet"
zerombr yes
clearpart --all --initlabel $tag_drives
EOF

else

cat >> /tmp/disk.cfg <<EOF
bootloader --location=mbr $tag_driveorder --append="crashkernel=auto rhgb quiet"
zerombr yes
clearpart --all --initlabel $tag_drives
part /boot/efi --fstype=efi --size=128 --asprimary
EOF

fi
chvt 1
%end


%post
chkconfig xencommons on
sed -i '/^-A INPUT -i lo -j ACCEPT/a\-I INPUT -m state --state NEW -m tcp -p tcp --dport 5900:9999 -j ACCEPT' /etc/sysconfig/iptables
sed -i '/^-A INPUT -i lo -j ACCEPT/a\-I INPUT -m state --state NEW -m tcp -p tcp --dport 44444 -j ACCEPT' /etc/sysconfig/iptables
sed -i '/^-A INPUT -i lo -j ACCEPT/a\-I INPUT -m state --state NEW -m tcp -p tcp --dport 49152:49215 -j ACCEPT' /etc/sysconfig/iptables

mkdir -p /boot/efi/EFI/BOOT
cp -r /boot/* /boot/efi/

if [ -f "/boot/efi/EFI/sugon/grub.conf" ];then
  sed -i '/^hiddenmenu/a\verbose=0' /boot/efi/EFI/sugon/grub.conf
  sed -i 's/^\tkernel/\tmodule/g' /boot/efi/EFI/sugon/grub.conf
  sed -i 's/^\tinitrd/\tmodule/g' /boot/efi/EFI/sugon/grub.conf
  sed -i '/^\troot/a\\tkernel /xen.gz dom0_mem=1024M,max:1024M loglvl=all vga=mode-0x317 guest_loglvl=all xencons=off' /boot/efi/EFI/sugon/grub.conf
  cp /boot/efi/EFI/sugon/grub.conf /boot/efi/EFI/EFI/sugon/grub.conf
fi

[ -e "/boot/efi/EFI/sugon/grub.efi" ]   && cp /boot/efi/EFI/sugon/grub.efi /boot/efi/EFI/BOOT/BOOTX64.efi
[ -e "/boot/grub/grub.conf" ]            && cp /boot/grub/grub.conf /boot/efi/EFI/BOOT/BOOTX64.conf
[ -e "/boot/efi/EFI/BOOT/BOOTX64.conf" ] && cp /boot/efi/EFI/BOOT/BOOTX64.conf /boot/efi/EFI/BOOT/grub.conf
[ -e ""/boot/grub/splash.xpm.gz ]        && cp /boot/grub/splash.xpm.gz /boot/efi/EFI/BOOT/splash.xpm.gz

%end
